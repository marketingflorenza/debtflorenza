<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ - Florenza Clinic</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- CSS STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        /* Header */
        .header { text-align: center; }
        .header h1 { color: #2c3e50; font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .header p { color: #7f8c8d; font-size: 1.1rem; }

        /* Upload & Filter */
        .upload-container { text-align: center; }
        .upload-container h3 { color: #2c3e50; margin-bottom: 15px; }
        .upload-container input[type="file"] {
            margin-bottom: 20px; border: 2px dashed #bdc3c7; padding: 15px;
            border-radius: 10px; cursor: pointer; width: 100%; max-width: 400px;
        }
        button {
            background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none;
            padding: 10px 25px; border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
            font-weight: 600; margin: 5px;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        
        .filter-container {
            margin-top: 20px; padding-top: 20px; border-top: 1px solid #ecf0f1;
            display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;
        }
        .filter-container input[type="date"] { padding: 8px; border-radius: 8px; border: 1px solid #bdc3c7; }
        #filterBtn { background: #27ae60; }
        #resetBtn { background: #e67e22; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .stat-card {
            background: rgba(255, 255, 255, 0.9); padding: 25px; border-radius: 20px;
            text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon {
            width: 60px; height: 60px; margin: 0 auto 15px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;
        }
        .stat-card.overdue .stat-icon { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .stat-card.current .stat-icon { background: linear-gradient(135deg, #27ae60, #229954); }
        .stat-card.total .stat-icon { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .stat-card.customers .stat-icon { background: linear-gradient(135deg, #3498db, #2980b9); }
        .stat-value { font-size: 2rem; font-weight: 700; color: #2c3e50; }
        .stat-label { color: #7f8c8d; font-size: 1rem; }

        /* Charts */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
        .chart-container h3 { text-align: center; margin-bottom: 20px; color: #2c3e50; }

        /* Table */
        .table-container { overflow-x: auto; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Menu & Dropdown */
        .menu-container { position: relative; display: inline-block; }
        .menu-btn { background: none; color: #555; font-size: 24px; padding: 0 10px; border-radius: 5px; }
        .menu-btn:hover { background: #ecf0f1; box-shadow: none; transform: none; }
        .dropdown-content {
            display: none; position: absolute; right: 0; background-color: #fff;
            min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 10;
            border-radius: 8px; overflow: hidden; border: 1px solid #f0f0f0;
        }
        .dropdown-content a {
            color: #333; padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9rem;
        }
        .dropdown-content a:hover { background-color: #f5f5f5; }
        .show { display: block; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; white-space: nowrap; }
        th { background: #f8f9fa; font-weight: 600; color: #2c3e50; position: sticky; top: 0; user-select: none; }
        
        /* Sorting UI */
        th.sortable { cursor: pointer; transition: background 0.2s; }
        th.sortable:hover { background: #ecf0f1; }
        .sort-icon { display: inline-block; margin-left: 5px; font-size: 0.8em; color: #95a5a6; }
        th.sortable.active .sort-icon { color: #2c3e50; font-weight: bold; }

        tr.clickable-row:hover { background: #f0f3f4; cursor: pointer; }
        
        .status { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; text-align: center; }
        .status.overdue { background: #ffebee; color: #c62828; }
        .status.current { background: #e8f5e8; color: #2e7d32; }
        .status.prepaid { background: #e3f2fd; color: #1565c0; }
        
        .amount { font-weight: 600; }
        .amount.negative { color: #e74c3c; }
        .amount.positive { color: #27ae60; }
        
        .placeholder { text-align: center; padding: 40px; color: #95a5a6; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888;
            width: 80%; max-width: 900px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #000; }
        .modal-body { max-height: 60vh; overflow-y: auto; }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header card">
            <h1>üìä Dashboard ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</h1>
            <p>‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ - Florenza Clinic</p>
        </div>

        <div class="upload-container card">
            <h3>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</h3>
            <p>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .xlsx, .xls, .csv ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</p>
            <input type="file" id="fileInput" accept=".csv, .xls, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
            <br>
            <button id="processFileBtn">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <div class="filter-container">
                <label for="startDate">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà:</label>
                <input type="date" id="startDate" disabled>
                <label for="endDate">‡∏ñ‡∏∂‡∏á:</label>
                <input type="date" id="endDate" disabled>
                <button id="filterBtn" disabled>‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button id="resetBtn" disabled>‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á & ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="totalAmount">0</div>
                <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
            </div>
            <div class="stat-card overdue">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-value" id="overdueAmount">0</div>
                <div class="stat-label">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏ö‡∏≤‡∏ó)</div>
            </div>
            <div class="stat-card current">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="currentAmount">0</div>
                <div class="stat-label">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)</div>
            </div>
            <div class="stat-card customers">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="totalCustomers">0</div>
                <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏≤‡∏¢)</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container card">
                <h3>üìà ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</h3>
                <canvas id="statusChart"></canvas>
            </div>
            <div class="chart-container card">
                <h3>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ (Aging Report)</h3>
                <canvas id="agingChart"></canvas>
            </div>
        </div>

        <div class="table-container card">
            <div class="table-header">
                <h3>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢)</h3>
                <div class="menu-container">
                    <button id="tableMenuBtn" class="menu-btn">‚ãÆ</button>
                    <div id="tableMenu" class="dropdown-content">
                        <a href="#" id="exportExcelBtn">üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel</a>
                        <a href="#" id="printTableBtn">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á</a>
                    </div>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                        <th>‡πÄ‡∏•‡∏Ç HN</th>
                        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                        <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á</th>
                        <th class="sortable" onclick="sortTable('amount')">
                            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó) <span id="sortIcon-amount" class="sort-icon">‚áÖ</span>
                        </th>
                        <th class="sortable" onclick="sortTable('date')">
                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <span id="sortIcon-date" class="sort-icon">‚áÖ</span>
                        </th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô (‡∏Ñ‡πâ‡∏≤‡∏á/‡πÄ‡∏´‡∏•‡∏∑‡∏≠)</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody id="debtTable">
                    <tr><td colspan="9" class="placeholder">‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        let allCleanData = [];
        let currentDisplayData = []; 
        let customerDetails = {};
        let statusChart, agingChart;
        let currentSort = { column: null, direction: 'desc' }; // Default sort state

        // --- DOM Elements ---
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processFileBtn');
        const debtTableBody = document.getElementById('debtTable');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const filterBtn = document.getElementById('filterBtn');
        const resetBtn = document.getElementById('resetBtn');
        const modal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeBtn = document.querySelector('.close-btn');
        const tableMenuBtn = document.getElementById('tableMenuBtn');
        const tableMenu = document.getElementById('tableMenu');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const printTableBtn = document.getElementById('printTableBtn');

        // --- Initialize Charts ---
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        statusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î', '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', '‡∏ä‡∏≥‡∏£‡∏∞‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤'],
                datasets: [{ data: [0, 0, 0], backgroundColor: ['#e74c3c', '#27ae60', '#3498db'] }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        const agingCtx = document.getElementById('agingChart').getContext('2d');
        agingChart = new Chart(agingCtx, {
            type: 'bar',
            data: {
                labels: ['0-30 ‡∏ß‡∏±‡∏ô', '31-60 ‡∏ß‡∏±‡∏ô', '61-90 ‡∏ß‡∏±‡∏ô', '91+ ‡∏ß‡∏±‡∏ô'],
                datasets: [{ label: '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏ö‡∏≤‡∏ó)', data: [0, 0, 0, 0], backgroundColor: 'rgba(155, 89, 182, 0.8)', borderRadius: 5 }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        // --- Event Listeners ---
        processBtn.addEventListener('click', handleFileUpload);
        filterBtn.addEventListener('click', handleFilter);
        resetBtn.addEventListener('click', handleReset);
        closeBtn.onclick = () => { modal.style.display = "none"; };
        window.onclick = (event) => {
            if (event.target == modal) modal.style.display = "none";
            if (!event.target.matches('.menu-btn')) {
                if (tableMenu.classList.contains('show')) tableMenu.classList.remove('show');
            }
        };
        debtTableBody.addEventListener('click', (event) => {
            const row = event.target.closest('tr.clickable-row');
            if(row) showDetailsModal(row.dataset.customerName);
        });
        tableMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); tableMenu.classList.toggle('show'); });
        exportExcelBtn.addEventListener('click', (e) => { e.preventDefault(); exportTableToExcel(); tableMenu.classList.remove('show'); });
        printTableBtn.addEventListener('click', (e) => { e.preventDefault(); printCurrentTable(); tableMenu.classList.remove('show'); });

        // --- Main Functions ---

        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return; }

            const reader = new FileReader();
            const ext = file.name.split('.').pop().toLowerCase();

            if (ext === 'csv') {
                reader.onload = (e) => {
                    const rows = e.target.result.trim().split(/\r\n|\n/).slice(1).map(row => row.split(','));
                    parseReportData(rows);
                };
                reader.readAsText(file, 'UTF-8');
            } else if (['xlsx', 'xls'].includes(ext)) {
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    // raw: true helps us get accurate date serial numbers
                    const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true }); 
                    parseReportData(rows.slice(1));
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå .csv, .xlsx, ‡πÅ‡∏•‡∏∞ .xls ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
            }
        }

        // Robust Date Parser
        function parseInputDate(value) {
            if (!value) return null;
            // Case 1: Excel Serial Number (e.g., 45678)
            if (typeof value === 'number' && value > 20000) { 
                return new Date(Math.round((value - 25569) * 86400 * 1000));
            }
            // Case 2: String Date (e.g., "31/12/2024")
            const strVal = String(value).trim();
            const thaiDateMatch = strVal.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
            if (thaiDateMatch) {
                return new Date(thaiDateMatch[3], thaiDateMatch[2] - 1, thaiDateMatch[1]);
            }
            // Fallback
            const d = new Date(strVal);
            return isNaN(d.getTime()) ? null : d;
        }

        function parseReportData(sourceRows) {
            allCleanData = [];
            customerDetails = {};
            let currentCustomer = {};
            let latestDate = null;
            let outstandingItems = [];

            sourceRows.forEach(columns => {
                if (!columns || columns.length === 0) return;

                // Detect Customer Info Row
                if (columns[1] && String(columns[1]).includes('/')) {
                    const infoParts = String(columns[1]).split('/');
                    currentCustomer = {
                        name: infoParts[0] ? infoParts[0].trim() : '',
                        hn: infoParts[1] ? infoParts[1].trim() : '',
                        phone: infoParts[2] ? infoParts[2].trim() : ''
                    };
                    if (!customerDetails[currentCustomer.name]) {
                        customerDetails[currentCustomer.name] = { ...currentCustomer, transactions: [] };
                    }
                    latestDate = null; // Reset for new customer
                }

                const itemName = columns[3];
                const transactionDate = parseInputDate(columns[5]);
                
                // Process Transaction Row
                if (itemName && transactionDate) {
                    let balance = 0;
                    if (typeof columns[10] === 'number') balance = columns[10];
                    else if (typeof columns[10] === 'string') balance = parseFloat(columns[10].replace(/,/g, '')) || 0;
                    
                    const transaction = {
                        code: columns[2], item: itemName, receipt: columns[4],
                        date: transactionDate, balance: balance
                    };

                    if(currentCustomer.name && customerDetails[currentCustomer.name]) {
                       customerDetails[currentCustomer.name].transactions.push(transaction);
                    }

                    if (balance !== 0) outstandingItems.push(itemName);
                    
                    // Logic: Find the truly latest date
                    if (!latestDate || transactionDate > latestDate) {
                        latestDate = transactionDate;
                    }
                }

                // Process Summary Row ("‡∏£‡∏ß‡∏°")
                if (columns[5] && String(columns[5]).trim() === '‡∏£‡∏ß‡∏°') {
                    let finalAmount = 0;
                    if (typeof columns[10] === 'number') finalAmount = columns[10];
                    else if (typeof columns[10] === 'string') finalAmount = parseFloat(columns[10].replace(/,/g, '')) || 0;

                    if (finalAmount > 0 && currentCustomer.name && latestDate) {
                        const formattedDate = `${latestDate.getDate()}/${latestDate.getMonth() + 1}/${latestDate.getFullYear()}`;
                        // Data Structure: [Name, HN, Phone, Items, DebtAmount(Negative), DateString, RawDateObj]
                        allCleanData.push([
                            currentCustomer.name, 
                            currentCustomer.hn, 
                            currentCustomer.phone,
                            outstandingItems.join(', ') || 'N/A', 
                            -finalAmount, 
                            formattedDate
                        ]);
                    }
                    outstandingItems = [];
                    latestDate = null;
                    currentCustomer = {};
                }
            });
            
            if (allCleanData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            currentDisplayData = [...allCleanData];
            processCleanData(currentDisplayData);
            
            // Enable controls
            startDateInput.disabled = false;
            endDateInput.disabled = false;
            filterBtn.disabled = false;
            resetBtn.disabled = false;
        }

        function processCleanData(rows) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let totalDebt = 0, overdueDebt = 0, currentDebt = 0, prepaidAmount = 0;
            const agingBuckets = { '0-30': 0, '31-60': 0, '61-90': 0, '91+': 0 };
            let tableHTML = '';
            
            rows.forEach((columns, index) => {
                const [name, hn, phone, items, amount, dateStr] = columns;
                
                const dateParts = dateStr.split('/');
                const purchaseDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                const daysDiff = Math.floor((today - purchaseDate) / (1000 * 3600 * 24));
                
                let status, statusClass, dayText;
                
                if (amount >= 0) {
                    status = '‡∏ä‡∏≥‡∏£‡∏∞‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤'; statusClass = 'prepaid'; dayText = '-';
                    prepaidAmount += amount;
                } else {
                    totalDebt += Math.abs(amount);
                    if (daysDiff > 30) {
                        status = '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î'; statusClass = 'overdue'; dayText = `${daysDiff} ‡∏ß‡∏±‡∏ô`;
                        overdueDebt += Math.abs(amount);
                        if (daysDiff <= 60) agingBuckets['31-60'] += Math.abs(amount);
                        else if (daysDiff <= 90) agingBuckets['61-90'] += Math.abs(amount);
                        else agingBuckets['91+'] += Math.abs(amount);
                    } else {
                        status = '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'; statusClass = 'current'; dayText = `${30 - daysDiff} ‡∏ß‡∏±‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠`;
                        currentDebt += Math.abs(amount);
                        agingBuckets['0-30'] += Math.abs(amount);
                    }
                }

                tableHTML += `
                    <tr class="clickable-row" data-customer-name="${name}">
                        <td>${index + 1}</td>
                        <td>${name}</td>
                        <td>${hn}</td>
                        <td>${phone}</td>
                        <td>${items}</td>
                        <td class="amount ${amount < 0 ? 'negative' : 'positive'}">${formatCurrency(amount)}</td>
                        <td>${dateStr}</td>
                        <td>${dayText}</td>
                        <td><span class="status ${statusClass}">${status}</span></td>
                    </tr>
                `;
            });
            
            updateDashboard(
                { totalDebt, overdueDebt, currentDebt, prepaidAmount, customerCount: rows.length, agingBuckets },
                tableHTML
            );
        }

        // --- Sorting Logic ---
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc'; 
            }
            updateSortIcons(column, currentSort.direction);
            applySort();
        }

        function applySort() {
            if (!currentDisplayData || currentDisplayData.length === 0) return;
            const dir = currentSort.direction === 'asc' ? 1 : -1;

            currentDisplayData.sort((a, b) => {
                let valA, valB;
                if (currentSort.column === 'amount') {
                    valA = parseFloat(a[4]);
                    valB = parseFloat(b[4]);
                } else if (currentSort.column === 'date') {
                    valA = parseDateString(a[5]);
                    valB = parseDateString(b[5]);
                }
                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });

            processCleanData(currentDisplayData);
        }

        function parseDateString(dateStr) {
            const parts = dateStr.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
        }

        function updateSortIcons(activeColumn, direction) {
            document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('active'));
            document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '‚áÖ');
            
            const iconId = `sortIcon-${activeColumn}`;
            const iconEl = document.getElementById(iconId);
            const thEl = iconEl.closest('th');
            thEl.classList.add('active');
            iconEl.textContent = direction === 'asc' ? '‚ñ≤' : '‚ñº'; 
        }

        // --- Filtering & UI Updates ---
        function handleFilter() {
            const startDate = startDateInput.valueAsDate;
            const endDate = endDateInput.valueAsDate;
            
            if (!startDate || !endDate) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }
            if (startDate > endDate) { alert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
            
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);

            currentDisplayData = allCleanData.filter(row => {
                const dateParts = String(row[5]).split('/');
                const recordDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                return recordDate >= startDate && recordDate <= endDate;
            });
            
            if (currentSort.column) applySort();
            else processCleanData(currentDisplayData);
        }

        function handleReset() {
            startDateInput.value = '';
            endDateInput.value = '';
            currentDisplayData = [...allCleanData];
            currentSort = { column: null, direction: 'desc' };
            document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('active'));
            document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '‚áÖ');
            processCleanData(currentDisplayData);
        }

        function updateDashboard(stats, tableHTML) {
            animateValue(document.getElementById('totalAmount'), 0, stats.totalDebt, 800);
            animateValue(document.getElementById('overdueAmount'), 0, stats.overdueDebt, 800);
            animateValue(document.getElementById('currentAmount'), 0, stats.currentDebt, 800);
            animateValue(document.getElementById('totalCustomers'), 0, stats.customerCount, 800);

            statusChart.data.datasets[0].data = [stats.overdueDebt, stats.currentDebt, stats.prepaidAmount];
            statusChart.update();
            
            agingChart.data.datasets[0].data = [
                stats.agingBuckets['0-30'], stats.agingBuckets['31-60'],
                stats.agingBuckets['61-90'], stats.agingBuckets['91+']
            ];
            agingChart.update();
            
            debtTableBody.innerHTML = tableHTML || `<tr><td colspan="9" class="placeholder">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>`;
        }

        // --- Utilities ---
        function showDetailsModal(customerName) {
            const details = customerDetails[customerName];
            if (!details) return;

            modalTitle.innerHTML = `${details.name} <small style="display:block; font-size:0.9rem; color:#777; margin-top:5px;">HN: ${details.hn} | ${details.phone}</small>`;
            
            let html = `<table><thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr></thead><tbody>`;
            details.transactions.forEach(item => {
                html += `<tr>
                    <td>${item.code || ''}</td>
                    <td>${item.item || ''}</td>
                    <td>${item.receipt || ''}</td>
                    <td>${item.date.toLocaleDateString('th-TH')}</td>
                    <td class="amount">${formatCurrency(item.balance)}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            modalBody.innerHTML = html;
            modal.style.display = "block";
        }

        function formatCurrency(val) { return new Intl.NumberFormat('th-TH').format(val); }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = formatCurrency(Math.floor(progress * (end - start) + start));
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        // --- Export & Print ---
        function exportTableToExcel() {
            if (currentDisplayData.length === 0) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å'); return; }
            
            const dataToExport = currentDisplayData.map((row, index) => ({
                '‡∏•‡∏≥‡∏î‡∏±‡∏ö': index + 1,
                '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤': row[0],
                '‡πÄ‡∏•‡∏Ç HN': row[1],
                '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£': row[2],
                '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á': row[3],
                '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)': row[4],
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î': row[5],
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': calculateStatusText(row[4], row[5])
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            ws['!cols'] = [{wch:5}, {wch:25}, {wch:12}, {wch:12}, {wch:35}, {wch:15}, {wch:12}, {wch:15}];
            
            // Format Number Column (F is index 5)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                const cell = XLSX.utils.encode_cell({c: 5, r: R});
                if (ws[cell]) { ws[cell].t = 'n'; ws[cell].z = '#,##0.00'; }
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Debtors Report");
            XLSX.writeFile(wb, `Florenza_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
        
        function calculateStatusText(amount, dateStr) {
            if (amount >= 0) return '‡∏ä‡∏≥‡∏£‡∏∞‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤';
            const today = new Date(); today.setHours(0,0,0,0);
            const dateParts = dateStr.split('/');
            const pDate = new Date(dateParts[2], dateParts[1]-1, dateParts[0]);
            const diff = Math.floor((today - pDate)/(1000*3600*24));
            return diff > 30 ? `‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î (${diff} ‡∏ß‡∏±‡∏ô)` : `‡∏õ‡∏Å‡∏ï‡∏¥ (${30 - diff} ‡∏ß‡∏±‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠)`;
        }

        function printCurrentTable() {
            if (currentDisplayData.length === 0) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå'); return; }
            const tableHTML = document.querySelector('.table-container table').outerHTML;
            const win = window.open('', '', 'height=700,width=900');
            win.document.write(`<html><head><title>Print Report</title>
            <style>
                body{font-family:sans-serif;} table{width:100%;border-collapse:collapse;}
                th,td{border:1px solid #ddd;padding:8px;text-align:left;} th{background:#f2f2f2;}
                .amount.negative{color:red;} .amount.positive{color:green;}
            </style></head><body><h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ - Florenza Clinic</h2>${tableHTML}</body></html>`);
            win.document.close();
            win.print();
        }
    </script>
</body>
</html>
