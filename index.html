<!DOCTYPE html>
<html lang="th">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Dashboard à¸£à¸²à¸¢à¸‡à¸²à¸™à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰ - Florenza Clinic</title>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  /* --- CSS STYLES --- */
Â  Â  Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; }
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  }
Â  Â  Â  Â  .container { max-width: 1600px; margin: 0 auto; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Cards */
Â  Â  Â  Â  .card {
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.2);
Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Header */
Â  Â  Â  Â  .header { text-align: center; }
Â  Â  Â  Â  .header h1 { color: #2c3e50; font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
Â  Â  Â  Â  .header p { color: #7f8c8d; font-size: 1.1rem; }

Â  Â  Â  Â  /* Upload & Filter */
Â  Â  Â  Â  .upload-container { text-align: center; }
Â  Â  Â  Â  .upload-container h3 { color: #2c3e50; margin-bottom: 15px; }
Â  Â  Â  Â  .upload-container input[type="file"] {
Â  Â  Â  Â  Â  Â  margin-bottom: 20px; border: 2px dashed #bdc3c7; padding: 15px;
Â  Â  Â  Â  Â  Â  border-radius: 10px; cursor: pointer; width: 100%; max-width: 400px;
Â  Â  Â  Â  }
Â  Â  Â  Â  button {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none;
Â  Â  Â  Â  Â  Â  padding: 10px 25px; border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  font-weight: 600; margin: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
Â  Â  Â  Â  button:disabled { background: #bdc3c7; cursor: not-allowed; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .filter-container {
Â  Â  Â  Â  Â  Â  margin-top: 20px; padding-top: 20px; border-top: 1px solid #ecf0f1;
Â  Â  Â  Â  Â  Â  display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;
Â  Â  Â  Â  }
Â  Â  Â  Â  .filter-container input[type="date"] { padding: 8px; border-radius: 8px; border: 1px solid #bdc3c7; }
Â  Â  Â  Â  #filterBtn { background: #27ae60; }
Â  Â  Â  Â  #resetBtn { background: #e67e22; }

Â  Â  Â  Â  /* Stats Grid */
Â  Â  Â  Â  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 30px; }
Â  Â  Â  Â  .stat-card {
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.9); padding: 25px; border-radius: 20px;
Â  Â  Â  Â  Â  Â  text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
Â  Â  Â  Â  Â  Â  transition: transform 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .stat-card:hover { transform: translateY(-5px); }
Â  Â  Â  Â  .stat-icon {
Â  Â  Â  Â  Â  Â  width: 60px; height: 60px; margin: 0 auto 15px; border-radius: 50%;
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .stat-card.overdue .stat-icon { background: linear-gradient(135deg, #e74c3c, #c0392b); }
Â  Â  Â  Â  .stat-card.current .stat-icon { background: linear-gradient(135deg, #27ae60, #229954); }
Â  Â  Â  Â  .stat-card.total .stat-icon { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
Â  Â  Â  Â  .stat-card.customers .stat-icon { background: linear-gradient(135deg, #3498db, #2980b9); }
Â  Â  Â  Â  .stat-value { font-size: 2rem; font-weight: 700; color: #2c3e50; }
Â  Â  Â  Â  .stat-label { color: #7f8c8d; font-size: 1rem; }

Â  Â  Â  Â  /* Charts */
Â  Â  Â  Â  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
Â  Â  Â  Â  .chart-container h3 { text-align: center; margin-bottom: 20px; color: #2c3e50; }

Â  Â  Â  Â  /* Table */
Â  Â  Â  Â  .table-container { overflow-x: auto; }
Â  Â  Â  Â  .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Menu & Dropdown */
Â  Â  Â  Â  .menu-container { position: relative; display: inline-block; }
Â  Â  Â  Â  .menu-btn { background: none; color: #555; font-size: 24px; padding: 0 10px; border-radius: 5px; }
Â  Â  Â  Â  .menu-btn:hover { background: #ecf0f1; box-shadow: none; transform: none; }
Â  Â  Â  Â  .dropdown-content {
Â  Â  Â  Â  Â  Â  display: none; position: absolute; right: 0; background-color: #fff;
Â  Â  Â  Â  Â  Â  min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 10;
Â  Â  Â  Â  Â  Â  border-radius: 8px; overflow: hidden; border: 1px solid #f0f0f0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dropdown-content a {
Â  Â  Â  Â  Â  Â  color: #333; padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dropdown-content a:hover { background-color: #f5f5f5; }
Â  Â  Â  Â  .show { display: block; }

Â  Â  Â  Â  table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
Â  Â  Â  Â  th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; white-space: nowrap; }
Â  Â  Â  Â  th { background: #f8f9fa; font-weight: 600; color: #2c3e50; position: sticky; top: 0; user-select: none; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Sorting UI */
Â  Â  Â  Â  th.sortable { cursor: pointer; transition: background 0.2s; }
Â  Â  Â  Â  th.sortable:hover { background: #ecf0f1; }
Â  Â  Â  Â  .sort-icon { display: inline-block; margin-left: 5px; font-size: 0.8em; color: #95a5a6; }
Â  Â  Â  Â  th.sortable.active .sort-icon { color: #2c3e50; font-weight: bold; }

Â  Â  Â  Â  tr.clickable-row:hover { background: #f0f3f4; cursor: pointer; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .status { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; text-align: center; }
Â  Â  Â  Â  .status.overdue { background: #ffebee; color: #c62828; }
Â  Â  Â  Â  .status.current { background: #e8f5e8; color: #2e7d32; }
Â  Â  Â  Â  .status.prepaid { background: #e3f2fd; color: #1565c0; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .amount { font-weight: 600; }
Â  Â  Â  Â  .amount.negative { color: #e74c3c; }
Â  Â  Â  Â  .amount.positive { color: #27ae60; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .placeholder { text-align: center; padding: 40px; color: #95a5a6; }

Â  Â  Â  Â  /* Modal */
Â  Â  Â  Â  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888;
Â  Â  Â  Â  Â  Â  width: 80%; max-width: 900px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
Â  Â  Â  Â  .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
Â  Â  Â  Â  .close-btn:hover { color: #000; }
Â  Â  Â  Â  .modal-body { max-height: 60vh; overflow-y: auto; }

Â  Â  Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  Â  Â  .charts-grid { grid-template-columns: 1fr; }
Â  Â  Â  Â  Â  Â  .header h1 { font-size: 1.8rem; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div class="container">
Â  Â  Â  Â  <div class="header card">
Â  Â  Â  Â  Â  Â  <h1>ğŸ“Š Dashboard à¸£à¸²à¸¢à¸‡à¸²à¸™à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰</h1>
Â  Â  Â  Â  Â  Â  <p>à¸ªà¸£à¸¸à¸›à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¹à¸¥à¸°à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰ - Florenza Clinic</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="upload-container card">
Â  Â  Â  Â  Â  Â  <h3>ğŸ“¤ à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œà¸£à¸²à¸¢à¸‡à¸²à¸™à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰</h3>
Â  Â  Â  Â  Â  Â  <p>à¸£à¸­à¸‡à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ .xlsx, .xls, .csv à¸ˆà¸²à¸à¸£à¸°à¸šà¸š</p>
Â  Â  Â  Â  Â  Â  <input type="file" id="fileInput" accept=".csv, .xls, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
Â  Â  Â  Â  Â  Â  <br>
Â  Â  Â  Â  Â  Â  <button id="processFileBtn">à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>
Â  Â  Â  Â  Â  Â  <div class="filter-container">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="startDate">à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆ:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="startDate" disabled>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="endDate">à¸–à¸¶à¸‡:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="endDate" disabled>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="filterBtn" disabled>à¸à¸£à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="resetBtn" disabled>à¸¥à¹‰à¸²à¸‡à¸•à¸±à¸§à¸à¸£à¸­à¸‡ & à¸£à¸µà¹€à¸‹à¹‡à¸•à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸‡</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="stats-grid">
Â  Â  Â  Â  Â  Â  <div class="stat-card total">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-icon">ğŸ’°</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value" id="totalAmount">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">à¸¢à¸­à¸”à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰à¸£à¸§à¸¡ (à¸šà¸²à¸—)</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="stat-card overdue">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-icon">âš ï¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value" id="overdueAmount">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰à¹€à¸à¸´à¸™à¸à¸³à¸«à¸™à¸” (à¸šà¸²à¸—)</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="stat-card current">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-icon">âœ…</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value" id="currentAmount">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ (à¸šà¸²à¸—)</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="stat-card customers">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-icon">ğŸ‘¥</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value" id="totalCustomers">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">à¸ˆà¸³à¸™à¸§à¸™à¸¥à¸¹à¸à¸„à¹‰à¸² (à¸£à¸²à¸¢)</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="charts-grid">
Â  Â  Â  Â  Â  Â  <div class="chart-container card">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“ˆ à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸ªà¸–à¸²à¸™à¸°à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="statusChart"></canvas>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="chart-container card">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“Š à¸£à¸²à¸¢à¸‡à¸²à¸™à¸­à¸²à¸¢à¸¸à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰ (Aging Report)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="agingChart"></canvas>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="table-container card">
Â  Â  Â  Â  Â  Â  <div class="table-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“‹ à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰ (à¸„à¸¥à¸´à¸à¹à¸–à¸§à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¹ˆà¸­à¸¢)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="tableMenuBtn" class="menu-btn">â‹®</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="tableMenu" class="dropdown-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" id="exportExcelBtn">ğŸ“„ à¸ªà¹ˆà¸‡à¸­à¸­à¸à¹€à¸›à¹‡à¸™ Excel</a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" id="printTableBtn">ğŸ–¨ï¸ à¸à¸´à¸¡à¸à¹Œà¸•à¸²à¸£à¸²à¸‡</a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>à¸¥à¸³à¸”à¸±à¸š</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>à¸Šà¸·à¹ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>à¹€à¸¥à¸‚ HN</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸µà¹ˆà¸„à¹‰à¸²à¸‡</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="sortable" onclick="sortTable('amount')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™ (à¸šà¸²à¸—) <span id="sortIcon-amount" class="sort-icon">â‡…</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="sortable" onclick="sortTable('date')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  à¸§à¸±à¸™à¸—à¸µà¹ˆà¸‹à¸·à¹‰à¸­à¸¥à¹ˆà¸²à¸ªà¸¸à¸” <span id="sortIcon-date" class="sort-icon">â‡…</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™ (à¸„à¹‰à¸²à¸‡/à¹€à¸«à¸¥à¸·à¸­)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>à¸ªà¸–à¸²à¸™à¸°</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="debtTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="9" class="placeholder">à¹‚à¸›à¸£à¸”à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸·à¹ˆà¸­à¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="detailsModal" class="modal">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="modalTitle">à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸£à¸²à¸¢à¸à¸²à¸£</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="close-btn">&times;</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-body" id="modalBody"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- Global Variables ---
Â  Â  Â  Â  let allCleanData = [];
Â  Â  Â  Â  let currentDisplayData = [];Â 
Â  Â  Â  Â  let customerDetails = {};
Â  Â  Â  Â  let statusChart, agingChart;
Â  Â  Â  Â  let currentSort = { column: null, direction: 'desc' }; // Default sort state

Â  Â  Â  Â  // --- DOM Elements ---
Â  Â  Â  Â  const fileInput = document.getElementById('fileInput');
Â  Â  Â  Â  const processBtn = document.getElementById('processFileBtn');
Â  Â  Â  Â  const debtTableBody = document.getElementById('debtTable');
Â  Â  Â  Â  const startDateInput = document.getElementById('startDate');
Â  Â  Â  Â  const endDateInput = document.getElementById('endDate');
Â  Â  Â  Â  const filterBtn = document.getElementById('filterBtn');
Â  Â  Â  Â  const resetBtn = document.getElementById('resetBtn');
Â  Â  Â  Â  const modal = document.getElementById('detailsModal');
Â  Â  Â  Â  const modalTitle = document.getElementById('modalTitle');
Â  Â  Â  Â  const modalBody = document.getElementById('modalBody');
Â  Â  Â  Â  const closeBtn = document.querySelector('.close-btn');
Â  Â  Â  Â  const tableMenuBtn = document.getElementById('tableMenuBtn');
Â  Â  Â  Â  const tableMenu = document.getElementById('tableMenu');
Â  Â  Â  Â  const exportExcelBtn = document.getElementById('exportExcelBtn');
Â  Â  Â  Â  const printTableBtn = document.getElementById('printTableBtn');

Â  Â  Â  Â  // --- Initialize Charts ---
Â  Â  Â  Â  const statusCtx = document.getElementById('statusChart').getContext('2d');
Â  Â  Â  Â  statusChart = new Chart(statusCtx, {
Â  Â  Â  Â  Â  Â  type: 'doughnut',
Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  labels: ['à¹€à¸à¸´à¸™à¸à¸³à¸«à¸™à¸”', 'à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™', 'à¸Šà¸³à¸£à¸°à¸¥à¹ˆà¸§à¸‡à¸«à¸™à¹‰à¸²'],
Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{ data: [0, 0, 0], backgroundColor: ['#e74c3c', '#27ae60', '#3498db'] }]
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
Â  Â  Â  Â  });

Â  Â  Â  Â  const agingCtx = document.getElementById('agingChart').getContext('2d');
Â  Â  Â  Â  agingChart = new Chart(agingCtx, {
Â  Â  Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  labels: ['0-30 à¸§à¸±à¸™', '31-60 à¸§à¸±à¸™', '61-90 à¸§à¸±à¸™', '91+ à¸§à¸±à¸™'],
Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{ label: 'à¸¢à¸­à¸”à¸„à¹‰à¸²à¸‡à¸Šà¸³à¸£à¸° (à¸šà¸²à¸—)', data: [0, 0, 0, 0], backgroundColor: 'rgba(155, 89, 182, 0.8)', borderRadius: 5 }]
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  options: { responsive: true, scales: { y: { beginAtZero: true } } }
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- Event Listeners ---
Â  Â  Â  Â  processBtn.addEventListener('click', handleFileUpload);
Â  Â  Â  Â  filterBtn.addEventListener('click', handleFilter);
Â  Â  Â  Â  resetBtn.addEventListener('click', handleReset);
Â  Â  Â  Â  closeBtn.onclick = () => { modal.style.display = "none"; };
Â  Â  Â  Â  window.onclick = (event) => {
Â  Â  Â  Â  Â  Â  if (event.target == modal) modal.style.display = "none";
Â  Â  Â  Â  Â  Â  if (!event.target.matches('.menu-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  if (tableMenu.classList.contains('show')) tableMenu.classList.remove('show');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  debtTableBody.addEventListener('click', (event) => {
Â  Â  Â  Â  Â  Â  const row = event.target.closest('tr.clickable-row');
Â  Â  Â  Â  Â  Â  if(row) showDetailsModal(row.dataset.customerName);
Â  Â  Â  Â  });
Â  Â  Â  Â  tableMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); tableMenu.classList.toggle('show'); });
Â  Â  Â  Â  exportExcelBtn.addEventListener('click', (e) => { e.preventDefault(); exportTableToExcel(); tableMenu.classList.remove('show'); });
Â  Â  Â  Â  printTableBtn.addEventListener('click', (e) => { e.preventDefault(); printCurrentTable(); tableMenu.classList.remove('show'); });

Â  Â  Â  Â  // --- Main Functions ---

Â  Â  Â  Â  function handleFileUpload() {
Â  Â  Â  Â  Â  Â  const file = fileInput.files[0];
Â  Â  Â  Â  Â  Â  if (!file) { alert('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œà¸à¹ˆà¸­à¸™à¸„à¸£à¸±à¸š'); return; }

Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  const ext = file.name.split('.').pop().toLowerCase();

Â  Â  Â  Â  Â  Â  if (ext === 'csv') {
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rows = e.target.result.trim().split(/\r\n|\n/).slice(1).map(row => row.split(','));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parseReportData(rows);
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsText(file, 'UTF-8');
Â  Â  Â  Â  Â  Â  } else if (['xlsx', 'xls'].includes(ext)) {
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = new Uint8Array(e.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const workbook = XLSX.read(data, { type: 'array' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const worksheet = workbook.Sheets[workbook.SheetNames[0]];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // raw: true helps us get accurate date serial numbers
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parseReportData(rows.slice(1));
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsArrayBuffer(file);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert('à¸£à¸­à¸‡à¸£à¸±à¸šà¹€à¸‰à¸à¸²à¸°à¹„à¸Ÿà¸¥à¹Œ .csv, .xlsx, à¹à¸¥à¸° .xls à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Robust Date Parser
Â  Â  Â  Â  function parseInputDate(value) {
Â  Â  Â  Â  Â  Â  if (!value) return null;
Â  Â  Â  Â  Â  Â  // Case 1: Excel Serial Number (e.g., 45678)
Â  Â  Â  Â  Â  Â  if (typeof value === 'number' && value > 20000) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  return new Date(Math.round((value - 25569) * 86400 * 1000));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Case 2: String Date (e.g., "31/12/2024")
Â  Â  Â  Â  Â  Â  const strVal = String(value).trim();
Â  Â  Â  Â  Â  Â  const thaiDateMatch = strVal.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
Â  Â  Â  Â  Â  Â  if (thaiDateMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  return new Date(thaiDateMatch[3], thaiDateMatch[2] - 1, thaiDateMatch[1]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Fallback
Â  Â  Â  Â  Â  Â  const d = new Date(strVal);
Â  Â  Â  Â  Â  Â  return isNaN(d.getTime()) ? null : d;
Â  Â  Â  Â  }

Â  Â  Â  Â  function parseReportData(sourceRows) {
Â  Â  Â  Â  Â  Â  allCleanData = [];
Â  Â  Â  Â  Â  Â  customerDetails = {};
Â  Â  Â  Â  Â  Â  let currentCustomer = {};
Â  Â  Â  Â  Â  Â  let latestDate = null;
Â  Â  Â  Â  Â  Â  let outstandingItems = [];

Â  Â  Â  Â  Â  Â  sourceRows.forEach(columns => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!columns || columns.length === 0) return;

Â  Â  Â  Â  Â  Â  Â  Â  // Detect Customer Info Row
Â  Â  Â  Â  Â  Â  Â  Â  if (columns[1] && String(columns[1]).includes('/')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const infoParts = String(columns[1]).split('/');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentCustomer = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: infoParts[0] ? infoParts[0].trim() : '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hn: infoParts[1] ? infoParts[1].trim() : '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  phone: infoParts[2] ? infoParts[2].trim() : ''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!customerDetails[currentCustomer.name]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  customerDetails[currentCustomer.name] = { ...currentCustomer, transactions: [] };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latestDate = null; // Reset for new customer
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const itemName = columns[3];
Â  Â  Â  Â  Â  Â  Â  Â  const transactionDate = parseInputDate(columns[5]);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Process Transaction Row
Â  Â  Â  Â  Â  Â  Â  Â  if (itemName && transactionDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let balance = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof columns[10] === 'number') balance = columns[10];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (typeof columns[10] === 'string') balance = parseFloat(columns[10].replace(/,/g, '')) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const transaction = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  code: columns[2], item: itemName, receipt: columns[4],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: transactionDate, balance: balance
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(currentCustomer.name && customerDetails[currentCustomer.name]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â customerDetails[currentCustomer.name].transactions.push(transaction);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (balance !== 0) outstandingItems.push(itemName);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Logic: Find the truly latest date
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!latestDate || transactionDate > latestDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latestDate = transactionDate;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Process Summary Row ("à¸£à¸§à¸¡")
Â  Â  Â  Â  Â  Â  Â  Â  if (columns[5] && String(columns[5]).trim() === 'à¸£à¸§à¸¡') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let finalAmount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof columns[10] === 'number') finalAmount = columns[10];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (typeof columns[10] === 'string') finalAmount = parseFloat(columns[10].replace(/,/g, '')) || 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (finalAmount > 0 && currentCustomer.name && latestDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formattedDate = `${latestDate.getDate()}/${latestDate.getMonth() + 1}/${latestDate.getFullYear()}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Data Structure: [Name, HN, Phone, Items, DebtAmount(Negative), DateString, RawDateObj]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allCleanData.push([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentCustomer.name,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentCustomer.hn,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentCustomer.phone,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  outstandingItems.join(', ') || 'N/A',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -finalAmount,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  formattedDate
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  outstandingItems = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latestDate = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentCustomer = {};
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (allCleanData.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰ à¸«à¸£à¸·à¸­à¸£à¸¹à¸›à¹à¸šà¸šà¹„à¸Ÿà¸¥à¹Œà¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  currentDisplayData = [...allCleanData];
Â  Â  Â  Â  Â  Â  processCleanData(currentDisplayData);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Enable controls
Â  Â  Â  Â  Â  Â  startDateInput.disabled = false;
Â  Â  Â  Â  Â  Â  endDateInput.disabled = false;
Â  Â  Â  Â  Â  Â  filterBtn.disabled = false;
Â  Â  Â  Â  Â  Â  resetBtn.disabled = false;
Â  Â  Â  Â  }

Â  Â  Â  Â  function processCleanData(rows) {
Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  today.setHours(0, 0, 0, 0);

Â  Â  Â  Â  Â  Â  let totalDebt = 0, overdueDebt = 0, currentDebt = 0, prepaidAmount = 0;
Â  Â  Â  Â  Â  Â  const agingBuckets = { '0-30': 0, '31-60': 0, '61-90': 0, '91+': 0 };
Â  Â  Â  Â  Â  Â  let tableHTML = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  rows.forEach((columns, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const [name, hn, phone, items, amount, dateStr] = columns;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const dateParts = dateStr.split('/');
Â  Â  Â  Â  Â  Â  Â  Â  const purchaseDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
Â  Â  Â  Â  Â  Â  Â  Â  const daysDiff = Math.floor((today - purchaseDate) / (1000 * 3600 * 24));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let status, statusClass, dayText;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (amount >= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status = 'à¸Šà¸³à¸£à¸°à¸¥à¹ˆà¸§à¸‡à¸«à¸™à¹‰à¸²'; statusClass = 'prepaid'; dayText = '-';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  prepaidAmount += amount;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalDebt += Math.abs(amount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (daysDiff > 30) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status = 'à¹€à¸à¸´à¸™à¸à¸³à¸«à¸™à¸”'; statusClass = 'overdue'; dayText = `${daysDiff} à¸§à¸±à¸™`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  overdueDebt += Math.abs(amount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (daysDiff <= 60) agingBuckets['31-60'] += Math.abs(amount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (daysDiff <= 90) agingBuckets['61-90'] += Math.abs(amount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else agingBuckets['91+'] += Math.abs(amount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status = 'à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™'; statusClass = 'current'; dayText = `${30 - daysDiff} à¸§à¸±à¸™à¹€à¸«à¸¥à¸·à¸­`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentDebt += Math.abs(amount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  agingBuckets['0-30'] += Math.abs(amount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="clickable-row" data-customer-name="${name}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${index + 1}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${hn}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${phone}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${items}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="amount ${amount < 0 ? 'negative' : 'positive'}">${formatCurrency(amount)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${dateStr}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${dayText}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="status ${statusClass}">${status}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  updateDashboard(
Â  Â  Â  Â  Â  Â  Â  Â  { totalDebt, overdueDebt, currentDebt, prepaidAmount, customerCount: rows.length, agingBuckets },
Â  Â  Â  Â  Â  Â  Â  Â  tableHTML
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Sorting Logic ---
Â  Â  Â  Â  function sortTable(column) {
Â  Â  Â  Â  Â  Â  if (currentSort.column === column) {
Â  Â  Â  Â  Â  Â  Â  Â  currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  currentSort.column = column;
Â  Â  Â  Â  Â  Â  Â  Â  currentSort.direction = 'desc';Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateSortIcons(column, currentSort.direction);
Â  Â  Â  Â  Â  Â  applySort();
Â  Â  Â  Â  }

Â  Â  Â  Â  function applySort() {
Â  Â  Â  Â  Â  Â  if (!currentDisplayData || currentDisplayData.length === 0) return;
Â  Â  Â  Â  Â  Â  const dir = currentSort.direction === 'asc' ? 1 : -1;

Â  Â  Â  Â  Â  Â  currentDisplayData.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  let valA, valB;
Â  Â  Â  Â  Â  Â  Â  Â  if (currentSort.column === 'amount') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valA = parseFloat(a[4]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valB = parseFloat(b[4]);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (currentSort.column === 'date') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valA = parseDateString(a[5]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valB = parseDateString(b[5]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (valA < valB) return -1 * dir;
Â  Â  Â  Â  Â  Â  Â  Â  if (valA > valB) return 1 * dir;
Â  Â  Â  Â  Â  Â  Â  Â  return 0;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  processCleanData(currentDisplayData);
Â  Â  Â  Â  }

Â  Â  Â  Â  function parseDateString(dateStr) {
Â  Â  Â  Â  Â  Â  const parts = dateStr.split('/');
Â  Â  Â  Â  Â  Â  return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateSortIcons(activeColumn, direction) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('active'));
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = 'â‡…');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const iconId = `sortIcon-${activeColumn}`;
Â  Â  Â  Â  Â  Â  const iconEl = document.getElementById(iconId);
Â  Â  Â  Â  Â  Â  const thEl = iconEl.closest('th');
Â  Â  Â  Â  Â  Â  thEl.classList.add('active');
Â  Â  Â  Â  Â  Â  iconEl.textContent = direction === 'asc' ? 'â–²' : 'â–¼';Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Filtering & UI Updates ---
Â  Â  Â  Â  function handleFilter() {
Â  Â  Â  Â  Â  Â  const startDate = startDateInput.valueAsDate;
Â  Â  Â  Â  Â  Â  const endDate = endDateInput.valueAsDate;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!startDate || !endDate) { alert('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸Šà¹ˆà¸§à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆà¹ƒà¸«à¹‰à¸„à¸£à¸šà¸–à¹‰à¸§à¸™'); return; }
Â  Â  Â  Â  Â  Â  if (startDate > endDate) { alert('à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸•à¹‰à¸­à¸‡à¸¡à¸²à¸à¹ˆà¸­à¸™à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”'); return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  startDate.setHours(0, 0, 0, 0);
Â  Â  Â  Â  Â  Â  endDate.setHours(23, 59, 59, 999);

Â  Â  Â  Â  Â  Â  currentDisplayData = allCleanData.filter(row => {
Â  Â  Â  Â  Â  Â  Â  Â  const dateParts = String(row[5]).split('/');
Â  Â  Â  Â  Â  Â  Â  Â  const recordDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
Â  Â  Â  Â  Â  Â  Â  Â  return recordDate >= startDate && recordDate <= endDate;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (currentSort.column) applySort();
Â  Â  Â  Â  Â  Â  else processCleanData(currentDisplayData);
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleReset() {
Â  Â  Â  Â  Â  Â  startDateInput.value = '';
Â  Â  Â  Â  Â  Â  endDateInput.value = '';
Â  Â  Â  Â  Â  Â  currentDisplayData = [...allCleanData];
Â  Â  Â  Â  Â  Â  currentSort = { column: null, direction: 'desc' };
Â  Â  Â  Â  Â  Â  document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('active'));
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = 'â‡…');
Â  Â  Â  Â  Â  Â  processCleanData(currentDisplayData);
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateDashboard(stats, tableHTML) {
Â  Â  Â  Â  Â  Â  animateValue(document.getElementById('totalAmount'), 0, stats.totalDebt, 800);
Â  Â  Â  Â  Â  Â  animateValue(document.getElementById('overdueAmount'), 0, stats.overdueDebt, 800);
Â  Â  Â  Â  Â  Â  animateValue(document.getElementById('currentAmount'), 0, stats.currentDebt, 800);
Â  Â  Â  Â  Â  Â  animateValue(document.getElementById('totalCustomers'), 0, stats.customerCount, 800);

Â  Â  Â  Â  Â  Â  statusChart.data.datasets[0].data = [stats.overdueDebt, stats.currentDebt, stats.prepaidAmount];
Â  Â  Â  Â  Â  Â  statusChart.update();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  agingChart.data.datasets[0].data = [
Â  Â  Â  Â  Â  Â  Â  Â  stats.agingBuckets['0-30'], stats.agingBuckets['31-60'],
Â  Â  Â  Â  Â  Â  Â  Â  stats.agingBuckets['61-90'], stats.agingBuckets['91+']
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  agingChart.update();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  debtTableBody.innerHTML = tableHTML || `<tr><td colspan="9" class="placeholder">à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸•à¸£à¸‡à¸•à¸²à¸¡à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚</td></tr>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Utilities ---
Â  Â  Â  Â  function showDetailsModal(customerName) {
Â  Â  Â  Â  Â  Â  const details = customerDetails[customerName];
Â  Â  Â  Â  Â  Â  if (!details) return;

Â  Â  Â  Â  Â  Â  modalTitle.innerHTML = `${details.name} <small style="display:block; font-size:0.9rem; color:#777; margin-top:5px;">HN: ${details.hn} | ${details.phone}</small>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let html = `<table><thead><tr><th>à¸£à¸«à¸±à¸ª</th><th>à¸£à¸²à¸¢à¸à¸²à¸£</th><th>à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ</th><th>à¸§à¸±à¸™à¸—à¸µà¹ˆ</th><th>à¸¢à¸­à¸”à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­</th></tr></thead><tbody>`;
Â  Â  Â  Â  Â  Â  details.transactions.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${item.code || ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${item.item || ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${item.receipt || ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${item.date.toLocaleDateString('th-TH')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="amount">${formatCurrency(item.balance)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  html += `</tbody></table>`;
Â  Â  Â  Â  Â  Â  modalBody.innerHTML = html;
Â  Â  Â  Â  Â  Â  modal.style.display = "block";
Â  Â  Â  Â  }

Â  Â  Â  Â  function formatCurrency(val) { return new Intl.NumberFormat('th-TH').format(val); }

Â  Â  Â  Â  function animateValue(obj, start, end, duration) {
Â  Â  Â  Â  Â  Â  let startTimestamp = null;
Â  Â  Â  Â  Â  Â  const step = (timestamp) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!startTimestamp) startTimestamp = timestamp;
Â  Â  Â  Â  Â  Â  Â  Â  const progress = Math.min((timestamp - startTimestamp) / duration, 1);
Â  Â  Â  Â  Â  Â  Â  Â  obj.innerHTML = formatCurrency(Math.floor(progress * (end - start) + start));
Â  Â  Â  Â  Â  Â  Â  Â  if (progress < 1) window.requestAnimationFrame(step);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  window.requestAnimationFrame(step);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Export & Print ---
Â  Â  Â  Â  function exportTableToExcel() {
Â  Â  Â  Â  Â  Â  if (currentDisplayData.length === 0) { alert('à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¹ˆà¸‡à¸­à¸­à¸'); return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const dataToExport = currentDisplayData.map((row, index) => ({
Â  Â  Â  Â  Â  Â  Â  Â  'à¸¥à¸³à¸”à¸±à¸š': index + 1,
Â  Â  Â  Â  Â  Â  Â  Â  'à¸Šà¸·à¹ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²': row[0],
Â  Â  Â  Â  Â  Â  Â  Â  'à¹€à¸¥à¸‚ HN': row[1],
Â  Â  Â  Â  Â  Â  Â  Â  'à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£': row[2],
Â  Â  Â  Â  Â  Â  Â  Â  'à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸µà¹ˆà¸„à¹‰à¸²à¸‡': row[3],
Â  Â  Â  Â  Â  Â  Â  Â  'à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™ (à¸šà¸²à¸—)': row[4],
Â  Â  Â  Â  Â  Â  Â  Â  'à¸§à¸±à¸™à¸—à¸µà¹ˆà¸‹à¸·à¹‰à¸­à¸¥à¹ˆà¸²à¸ªà¸¸à¸”': row[5],
Â  Â  Â  Â  Â  Â  Â  Â  'à¸ªà¸–à¸²à¸™à¸°': calculateStatusText(row[4], row[5])
Â  Â  Â  Â  Â  Â  }));

Â  Â  Â  Â  Â  Â  const ws = XLSX.utils.json_to_sheet(dataToExport);
Â  Â  Â  Â  Â  Â  ws['!cols'] = [{wch:5}, {wch:25}, {wch:12}, {wch:12}, {wch:35}, {wch:15}, {wch:12}, {wch:15}];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Format Number Column (F is index 5)
Â  Â  Â  Â  Â  Â  const range = XLSX.utils.decode_range(ws['!ref']);
Â  Â  Â  Â  Â  Â  for (let R = range.s.r + 1; R <= range.e.r; ++R) {
Â  Â  Â  Â  Â  Â  Â  Â  const cell = XLSX.utils.encode_cell({c: 5, r: R});
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[cell]) { ws[cell].t = 'n'; ws[cell].z = '#,##0.00'; }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const wb = XLSX.utils.book_new();
Â  Â  Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, ws, "Debtors Report");
Â  Â  Â  Â  Â  Â  XLSX.writeFile(wb, `Florenza_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function calculateStatusText(amount, dateStr) {
Â  Â  Â  Â  Â  Â  if (amount >= 0) return 'à¸Šà¸³à¸£à¸°à¸¥à¹ˆà¸§à¸‡à¸«à¸™à¹‰à¸²';
Â  Â  Â  Â  Â  Â  const today = new Date(); today.setHours(0,0,0,0);
Â  Â  Â  Â  Â  Â  const dateParts = dateStr.split('/');
Â  Â  Â  Â  Â  Â  const pDate = new Date(dateParts[2], dateParts[1]-1, dateParts[0]);
Â  Â  Â  Â  Â  Â  const diff = Math.floor((today - pDate)/(1000*3600*24));
Â  Â  Â  Â  Â  Â  return diff > 30 ? `à¹€à¸à¸´à¸™à¸à¸³à¸«à¸™à¸” (${diff} à¸§à¸±à¸™)` : `à¸›à¸à¸•à¸´ (${30 - diff} à¸§à¸±à¸™à¹€à¸«à¸¥à¸·à¸­)`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function printCurrentTable() {
Â  Â  Â  Â  Â  Â  if (currentDisplayData.length === 0) { alert('à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸´à¸¡à¸à¹Œ'); return; }
Â  Â  Â  Â  Â  Â  const tableHTML = document.querySelector('.table-container table').outerHTML;
Â  Â  Â  Â  Â  Â  const win = window.open('', '', 'height=700,width=900');
Â  Â  Â  Â  Â  Â  win.document.write(`<html><head><title>Print Report</title>
Â  Â  Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  Â  Â  Â  body{font-family:sans-serif;} table{width:100%;border-collapse:collapse;}
Â  Â  Â  Â  Â  Â  Â  Â  th,td{border:1px solid #ddd;padding:8px;text-align:left;} th{background:#f2f2f2;}
Â  Â  Â  Â  Â  Â  Â  Â  .amount.negative{color:red;} .amount.positive{color:green;}
Â  Â  Â  Â  Â  Â  </style></head><body><h2>à¸£à¸²à¸¢à¸‡à¸²à¸™à¸¥à¸¹à¸à¸«à¸™à¸µà¹‰ - Florenza Clinic</h2>${tableHTML}</body></html>`);
Â  Â  Â  Â  Â  Â  win.document.close();
Â  Â  Â  Â  Â  Â  win.print();
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
